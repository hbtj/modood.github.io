『JavaScript 化整为零』之原型链
===============================

Table of contents
-----------------

*   [前言](#前言)
*   [原型对象：`prototype`](#原型对象prototype)
*   [原型：`__proto__`](#原型__proto__)
*   [构造函数：`constructor`](#构造函数constructor)
*   [普通对象和函数对象](#普通对象和函数对象)
*   [Object.prototype](#objectprototype)
*   [Function.prototype](#functionprototype)
*   [总结](#总结)
*   [参考资料](#参考资料)

## 前言

JavaScript 中的原型链非常简洁但是强大灵活，要完全理解原型链，需要先学习三个属性：

*   `prototype`
*   `__proto__`
*   `constructor`

## 原型对象：`prototype`

看一段代码：

```js
function Cat() {}

Cat.prototype.greet = function () {
  console.log('meow');
};
```

如何理解这段简单的代码呢？

1.  新建了一个函数 `Cat`。
2.  在 `Cat` 函数的 `prototype` 属性上新增了一个属性 `greet`，并给它赋值了一个函数。

需要留意的是，新建的函数 `Cat` 我们从未在它身上添加过任何属性，为什么会有一个名为 `prototype` 的属性呢。

并且我们在一个从未主动声明添加过的 `prototype` 属性上面新增一个 `greet` 属性竟然没有报错。

要知道如果运行以下代码是会报错的：

```js
function Cat() {}

Cat.something.greet = function () {
  console.log('meow');
};

// TypeError: Cannot set property 'greet' of undefined
```

因此我们得出第一个结论：

> JavaScript 给每个函数都会有一个名为 `prototype` 的属性，这个属性我们通常称为 “原型对象”。

原型对象 `prototype` 只是一个普通的对象，我们可以在其身上新增属性或方法。

## 原型：`__proto__`

在上述代码的基础上，以 `Cat` 函数作为构造函数创建一个新对象：

```js
function Cat() {}

Cat.prototype.greet = function () {
  console.log('meow');
};

var tom = new Cat();
tom.greet(); // 'meow'
```

看起来新对象 `tom` 好像拥有了一个 `greet` 方法并且调用成功了。

在 Chrome 浏览器中打印一下 `tom` 对象的值，可以看到：

```
tom
  __proto__: Object
```

发现 `tom` 对象只有一个名为 `__proto__` 的属性，属性的值为一个对象，但是 `tom` 并没有
`greet` 方法。为什么 `tom.greet` 可以调用成功呢？

尝试在 Chrome 中打印一下 `tom.__proto__` 的值。

```
tom.__proto__
  greet: function ()
```

发现在 `tom.__proto__` 下找到了这个 `greet` 方法，而 `tom.greet` 调用的其实就是这个 `tom.__proto__.greet`。

因此我们得出第二个结论：

> JavaScript 中每个对象都会有一个名为 `__proto__` 的属性，这个属性我们通常称为 “原型”。

> 当我们访问一个对象的属性时，如果这个对象内部不存在这个属性，那么他就会去 `__proto__` 属性里找这个属性。就是这样一层层地往上找原型，就构成了 JavaScript 中的原型链。

## 构造函数：`constructor`

仔细观察可以发现 `tom` 的 `__proto__` 属性和 `Cat` 的 `prototype` 属性实际上是全等的。即：

```js
tom.__proto__ === Cat.prototype
```

而除了 `__proto__` 属性，所有对象都还有一个名为 `constructor` 的属性，用于指向创建它的构造函数：

```js
tom.constructor === Cat
```

因此可以得出：

```js
tom.__proto__ === tom.constructor.prototype
```

因此我们得出第三结论：

> 在 JavaScript 中，创建对象的时候 `__proto__` 属性会指向创建它的构造函数的 `prototype` 属性

## 普通对象和函数对象

上文说过，所有函数都有 `prototype` 属性，所有对象都有 `__proto__` 属性。

因此，可以将 JavaScript 中的对象分为两种：

*   普通对象（只有 `__proto__` 属性，没有 `prototype` 属性）
*   函数对象（既有 `__proto__` 属性，也有 `prototype` 属性）

所有函数的 `prototype` 属性都是一个普通对象。

特殊情况（后面会讲到）：

*   `Object.prototype` 是一个特殊的普通对象。
*   `Function.prototype` 是一个特殊的函数对象。

## Object.prototype

理论上所有对象的 `__proto__` 的属性都指向创建它的构造函数的 `prototype` 属性，
使用字面量 `{}` 可以创建一个空对象，通过 `Object` 构造函数也可以创建对象，因此：

```js
({}).__proto__ === Object.prototype
```

但是 `Object.prototype` 是一个特殊的普通对象，特殊之处在于它的 `__proto__` 指向 `null`：

```js
Object.prototype.__proto__ === null
```

## Function.prototype

因为所有的函数对象都可以通过 `Function` 构造函数创建，所以：

> 所有函数的 `__proto__` 属性都指向 `Function` 构造函数的 `prototype` 属性

```js
(function(){}).__proto__ === Function.prototype

Object.__proto__ === Function.prototype
Function.__proto__ === Function.prototype
```

上文说过 `Function.prototype` 是一个特殊的函数对象，主要体现为两点：

1.  理论上所有函数对象既有 `__proto__` 属性，也有 `prototype` 属性。

    但是 `Function.prototype` 只有 `__proto__` 属性，没有 `prototype` 属性。

2.  理论上所有函数对象的 `__proto__` 属性都应该指向 `Function.prototype`。

    但是 `Function.prototype` 的 `__proto__` 属性指向了 `Object.prototype`。

```js
Function.prototype.__proto__ === Object.prototype
```

## 总结

总结一下原型链中的特殊性：

1.  `Function.prototype` 是一个特殊的函数对象。它没有 `prototype` 属性，它的 `__proto__` 属性指向 `Object.prototype`
2.  `Object.prototype` 是一个特殊的普通对象。它的 `__proto__` 属性指向 `null`

除了以上特殊性，以下所有结论都可以成立：

1.  JavaScript 中一切都是对象，对象分为普通对象和函数对象。所有对象都有 `__proto__` 属性和 `constructor` 属性。
2.  函数都是函数对象，函数对象都有 `prototype` 属性，`prototype` 属性是一个普通对象。
3.  所有对象的 `constructor` 属性都会指向创建它的构造函数，
    所有对象的 `__proto__` 属性会指向创建它的构造函数的 `prototype` 属性。

## 参考资料

*   [悟透JavaScript](http://www.cnblogs.com/leadzen/archive/2008/02/25/1073404.html)
*   [JS原型与原型链终极详解](http://www.108js.com/article/article1/10201.html)
*   [JavaScript 原型中的哲学思想](http://www.cnblogs.com/lvmylife/p/5625657.html)

```
                                                                         Cat                                           Animal
                                                      +--------------------------------------+       +--------------------------------------+
                            tom                       |                                      |       |                                      |
            +--------------------------------+        |  +--------------------------------+  |       |  +--------------------------------+  |
            |                                |        |  |                                |  |       |  |                                |  |
            |                                |        |  |                                |  |       |  |                                |  |
            |                                |        |  |            prototype           |  |       |  |            prototype           |  |
            |                                |        |  |                                |  |       |  |                                |  |
            |                                |        |  |                                |  |       |  |                                |  |
            |   +------------------------+   |        |  |   +------------------------+   |  |       |  |   +------------------------+   |  |
            |   |                        |   |        |  |   |                        |   |  |       |  |   |                        |   |  |
            |   |        __proto__       +--------------->   |        __proto__       +----------------->   |        __proto__       +------------------------------------------------------------+
            |   |                        |   |        |  |   |                        |   |  |       |  |   |                        |   |  |                                                     |
            |   +------------------------+   |        |  |   +------------------------+   |  |       |  |   +------------------------+   |  |                                                     |
            |                                |        |  |                                |  |       |  |                                |  |                                                     |
            +--------------------------------+        |  +--------------------------------+  |       |  +--------------------------------+  |                      Function                       |                          Object
                                                      |                                      |       |                                      |       +--------------------------------------+      |         +--------------------------------------+
                                                      |  +--------------------------------+  |       |  +--------------------------------+  |       |                                      |      |         |                                      |
                                                      |  |                                |  |       |  |                                |  |       |  +--------------------------------+  |      |         |  +--------------------------------+  |
                                                      |  |            __proto__           |  |       |  |            __proto__           |  |       |  |                                |  |      |         |  |                                |  |
                                                      |  |                                |  |       |  |                                |  |       |  |           prototype            |  |      |         |  |                                |  |
                                                      |  +--------------------------------+  |       |  +--------------------------------+  |       |  |                                |  |      |         |  |            prototype           |  |
                                                      |                   |                  |       |                   |                  |       |  |           __proto__            |  |      |         |  |                                |  |
                                                      +--------------------------------------+       +--------------------------------------+       |  |                                |  |      |         |  |                                |  |
                                                                          |                                              |                          |  |  +-------------------------+   |  |      |         |  |   +------------------------+   |  |
                                                                          |                                              +----------------------------->  |        __proto__        |   |  |      +------------>   |                        |   |  |
                                                                          +---------------------------------------------------------------------------->  |                         +-------------------------->   |        __proto__       +--------------------------> null
                                                                                                                         +----------------------------->  |                         |   |  |                |  |   |                        |   |  |
                                                                                                                         |                          |  |  +-------------------------+   |  |                |  |   +------------------------+   |  |
                                                                                                                         |                          |  |                                |  |                |  |                                |  |
                                                                                                                         |                          |  +--------------------------------+  |                |  +--------------------------------+  |
                                                                                                                         |                          |                                      |                |                                      |
                                                                                                                         |                          +--------------------------------------+                |  +--------------------------------+  |
                                                                                                                         |                                                                                  |  |                                |  |
                                                                                                                         |                                                                                  |  |            __proto__           |  |
                                                                                                                         |                                                                                  |  +--------------------------------+  |
                                                                                                                         |                                                                                  |                   |                  |
                                                                                                                         |                                                                                  +--------------------------------------+
                                                                                                                         |                                                                                                      |
                                                                                                                         +------------------------------------------------------------------------------------------------------+

